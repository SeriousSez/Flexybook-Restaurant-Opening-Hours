@using Flexybook.Domain.Responses.Restaurant
@using Flexybook.Domain
@using Flexybook___Restaurant_Opening_Hours.Helpers
@inject IJSRuntime JS
@rendermode InteractiveServer

<div class="opening-hours-section">
    <h2>Opening hours</h2>
    <div class="tabs-scroll" @ref="tabsScrollRef">
        <div class="tabs-inner">
            @foreach (var type in AvailableTypes)
            {
                <button type="button" class="tab @(SelectedType == type ? "active" : "")" @onclick="() => SetType(type)">
                    @GetTypeLabel(type)
                </button>
            }
        </div>
    </div>
    <table class="hours-table">
        @foreach (var row in OpeningHoursDisplayHelper.GetDisplayRows(Hours.Where(h => h.Type == SelectedType).ToList()))
        {
            <tr class="hours-row">
                <td>@row.Label</td>
                <td class="hours">@row.Hours</td>
            </tr>
        }
    </table>
</div>

@code {
    [Parameter]
    public List<OpeningHourResponse> Hours { get; set; } = new();

    private ElementReference tabsScrollRef;
    private OpeningHourType SelectedType { get; set; } = OpeningHourType.Restaurant;

    private IEnumerable<OpeningHourType> AvailableTypes =>
        Hours.Select(h => h.Type).Distinct();

    protected override void OnParametersSet()
    {
        if (!AvailableTypes.Contains(SelectedType) && AvailableTypes.Any())
        {
            SelectedType = AvailableTypes.First();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync("enableHorizontalWheelScroll", tabsScrollRef);
    }

    private void SetType(OpeningHourType type) => SelectedType = type;

    private string GetTypeLabel(OpeningHourType type) => type switch
    {
        OpeningHourType.Restaurant => "Restaurant",
        OpeningHourType.Takeaway => "Takeaway",
        OpeningHourType.Buffet => "Buffet",
        OpeningHourType.SpecialEventForGroups => "Special Events for Groups",
        _ => type.ToString()
    };
}