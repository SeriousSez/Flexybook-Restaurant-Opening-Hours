@page "/restaurant/{Id:guid}"
@using Flexybook.ApplicationService.Services
@using Flexybook.Domain.Responses.Restaurant
@using Flexybook___Restaurant_Opening_Hours.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@using Flexybook___Restaurant_Opening_Hours.Components.Shared;
@inject IRestaurantService RestaurantService
@inject IUserService UserService
@inject NavigationManager NavigationManager
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer
@implements IDisposable

@if (!string.IsNullOrEmpty(ToastMessage))
{
    <div class="toast @(ToastSuccess ? "success" : "failure")">@ToastMessage</div>
}

@if (restaurant is null || isLoading)
{
    <div class="restaurant-card skeleton-container">
        <div class="skeleton-header">
            <div class="title-row">
                <div class="skeleton skeleton-title"></div>
            </div>
            <div class="information-row">
                <div class="skeleton skeleton-text" style="width: 70px; height: 1.1rem;"></div>
                <div class="skeleton skeleton-text" style="width: 280px; height: 1.08rem;"></div>
            </div>
            <div class="skeleton-contact-row">
                <div class="skeleton skeleton-contact"></div>
                <div class="skeleton skeleton-contact"></div>
                <div class="skeleton skeleton-contact"></div>
            </div>
        </div>
        <div class="skeleton skeleton-gallery"></div>
        <div class="mobile-divider"></div>
        <div class="skeleton-opening-hours">
            <div class="skeleton skeleton-text" style="width: 140px; height: 1rem; margin-bottom: 2rem;"></div>
            <div style="margin-bottom: 1.2rem; display: flex; gap: .5rem;">
                <div class="skeleton skeleton-text" style="width: 110px; height: 2.2rem; border-radius: 20px; display: inline-block;"></div>
                <div class="skeleton skeleton-text" style="width: 110px; height: 2.2rem; border-radius: 20px; display: inline-block;"></div>
                <div class="skeleton skeleton-text" style="width: 110px; height: 2.2rem; border-radius: 20px; display: inline-block;"></div>
            </div>
            @for (int i = 0; i < 5; i++)
            {
                <div class="skeleton-day-time">
                    <div class="skeleton skeleton-text skeleton-day" style="width: 140px; height: 1.08rem;"></div>
                    <div class="skeleton skeleton-text skeleton-time" style="width: 110px; height: 1.08rem;"></div>
                </div>
            }
        </div>
        <div class="mobile-divider"></div>
    </div>
}
else
{
    <div class="restaurant-card">
        <div class="header">
            <div class="title-row">
                <h1 class="restaurant-title">@restaurant.Name</h1>
                @if (isAuthenticated)
                {
                    <span class="favourite-icon @(isFavourite ? "active" : "")" @onclick="ToggleFavouriteAsync" style="cursor:pointer;">&#9825;</span>
                }
            </div>
            <div class="information-row">
                <span class="status @(IsOpen ? "open" : "closed")">• @(IsOpen ? "Open" : "Closed")</span>
                <div class="information-divider">·</div>
                <div class="address">@restaurant.Address · @restaurant.City</div>
            </div>
            <ContactInfo Telephone="@restaurant.Telephone" Email="@restaurant.Email" />
        </div>
        <ImageGallery Images="@restaurant.Images" />
        <div class="mobile-divider"></div>
        <OpeningHours Hours="@restaurant.OpeningHours" />
        <div class="mobile-divider"></div>
    </div>
}

@code {
    [Parameter]
    public Guid Id { get; set; }
    private RestaurantResponse? restaurant;
    private string ToastMessage { get; set; } = "";
    private bool ToastSuccess { get; set; }
    private bool IsOpen { get; set; }
    private bool isFavourite = false;
    private bool isAuthenticated = false;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        restaurant = await RestaurantService.GetAsync(Id);
        if (restaurant is null)
        {
            isLoading = false;
            return;
        }

        IsRestaurantOpen(restaurant.OpeningHours);

        // Subscribe to authentication state changes
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckAuthenticationAndFavourites();
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await CheckAuthenticationAndFavourites();
        await InvokeAsync(StateHasChanged);
    }

    private async Task CheckAuthenticationAndFavourites()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;

        if (isAuthenticated)
        {
            await CheckIfFavourite();
        }
        else
        {
            isFavourite = false;
        }
    }

    private async Task CheckIfFavourite()
    {
        var userId = AuthStateProvider.GetUserId();
        if (!string.IsNullOrEmpty(userId))
        {
            var user = await UserService.GetUserAsync(userId);
            if (user?.FavouredRestaurants != null)
            {
                isFavourite = user.FavouredRestaurants.Contains(Id);
            }
        }
    }

    public void Dispose()
    {
        AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }

    private async Task ToggleFavouriteAsync()
    {
        if (restaurant is null)
            return;

        var userId = AuthStateProvider.GetUserId();
        if (string.IsNullOrEmpty(userId))
        {
            ToastSuccess = false;
            ToastMessage = "Please log in to add favorites";
            await Task.Delay(3000);
            ToastMessage = string.Empty;
            StateHasChanged();
            return;
        }

        var success = await UserService.UpdateUserFavouritesAsync(userId, restaurant.Id, !isFavourite);
        if (success)
        {
            isFavourite = !isFavourite;
            ToastSuccess = true;
            ToastMessage = isFavourite ? "Restaurant has been added as a favorite" : "Restaurant has been removed as a favorite";
        }
        else
        {
            ToastSuccess = false;
            ToastMessage = "Restaurant could not be updated as a favourite";
        }
        await Task.Delay(3000);
        ToastMessage = string.Empty;
        StateHasChanged();
    }

    private void IsRestaurantOpen(IEnumerable<OpeningHourResponse> openingHours)
    {
        var now = DateTime.Now;
        var today = now.DayOfWeek;

        var todayHours = openingHours
            .Where(h => h.DayOfWeek == today && !h.IsClosed)
            .FirstOrDefault();

        if (todayHours == null)
        {
            IsOpen = false;
            return;
        }

        var openTime = todayHours.OpenTime;
        var closeTime = todayHours.CloseTime;

        var currentTime = now.TimeOfDay;
        IsOpen = currentTime >= openTime && currentTime <= closeTime;
    }
}